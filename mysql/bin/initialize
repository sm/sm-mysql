#!/bin/sh

log "Initializing mysql data directory in $service_data_path"

paths create "${service_data_path%\/*}"

path chown "${package_user:="mysql"}:${package_user}" recursively  "${service_data_path%\/*}"

path chmod 0700 recursively "$service_data_path"

# --srcdir=\"${source_path}/${package_name}-${package_version}\"
export PATH="${install_path}/bin:$PATH"

if user is root
then
  exec /bin/su - "${package_user}" \
    "${sm_path}/bin/sm mysql initialize"

elif user is "${package_user}"
then
  if ${sm_path}/pkg/active/bin/mysql_install_db \
    --user="${package_user}" \
    --basedir="${sm_path}/pkg/versions/mysql/${package_version}" \
    --datadir="${service_data_path}"
  then
    log "Successfully initialized the database at ${service_data_path}"
  else
      log warn "There was an error ($?) initializing the database at ${service_data_path}"
  fi
else
  log error "The mysql database can only be initialized as the user ${package_user:-"mysql"}"
fi

log "Installing mysql init script"
template install "mysql/init.d" \
  to "${init_scripts_path}/mysql" \
  mode 0755

log "Installing mysql conf.d script"
template install "mysql/conf.d" \
  to "${confd_path}/mysql.conf" \
  mode 0644

log "
Installation and configuration of mysql is now complete.

* mysql has been installed to $install_path
* mysql configuration and data files will are in $service_data_path
* You can control the mysql server via the 'sm mysql' extension
* The mysql superuser is '$package_user', no password.
* Use /etc/conf.d/mysql.conf for server startup customization.

"
